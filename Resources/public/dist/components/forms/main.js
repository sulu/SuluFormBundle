define(["suluform/model/form","suluform/collections/forms"],function(a,b){"use strict";var c={listContainerId:"form-list-container",formContainerId:"form-form-container",rootUrl:"forms/",defaultTab:"general",formModule:"forms/form@suluform",listModule:"forms/list@suluform"},d="sulu.form.forms.",e=function(){return l.call(this,"navigate-list")},f=function(){return l.call(this,"navigate-to")},g=function(){return l.call(this,"navigate-add")},h=function(){return l.call(this,"changed")},i=function(){return l.call(this,"save")},j=function(){return l.call(this,"delete")},k=function(){return l.call(this,"deleted")},l=function(a){return d+a};return{collection:new b,language:null,initialize:function(){this.bindCustomEvents(),this.render()},getModel:function(b){if(this.collection.get(b))return this.collection.get(b);var c=new a;return b&&c.set({id:b}),this.collection.push(c),c},render:function(){if("list"===this.options.display)this.renderList(this.options.language);else{if("form"!==this.options.display)throw"display type wrong";this.renderForm(this.options.language)}},bindCustomEvents:function(){this.sandbox.on("sulu.header.language-changed",this.languageChanged.bind(this)),this.sandbox.on("husky.tabs.header.item.select",this.tabChanged.bind(this)),this.sandbox.on(e.call(this),this.navigateToList.bind(this)),this.sandbox.on(f.call(this),this.navigateTo.bind(this)),this.sandbox.on(g.call(this),this.navigateToAdd.bind(this)),this.sandbox.on(i.call(this),this.save.bind(this)),this.sandbox.on(j.call(this),this.deleteCollections.bind(this))},save:function(a,b){var c=this.getModel(a.id);c.set(a),c.save(null,{success:function(a){this.sandbox.emit(h.call(this),a.toJSON()),b(a.toJSON(),!0)}.bind(this),error:function(a,c){this.sandbox.logger.log("Error while saving form"),b(c.responseJSON,!1)}.bind(this)})},deleteCollections:function(a,b,c){var d,e=0;this.sandbox.sulu.showDeleteDialog(function(f){f===!0&&this.sandbox.util.foreach(a,function(f){d=this.getModel(f),d.destroy({success:function(){"function"==typeof b?b(f):this.sandbox.emit(k.call(this),f),e++,e===a.length&&"function"==typeof c&&c()}.bind(this),error:function(){this.sandbox.logger.log("Error while deleting a single form")}.bind(this)})}.bind(this))}.bind(this))},navigateToList:function(){this.sandbox.emit("sulu.router.navigate",c.rootUrl+this.options.language,!0,!0)},navigateTo:function(a,b){b=b?b:c.defaultTab,this.sandbox.emit("sulu.router.navigate",c.rootUrl+this.options.language+"/edit:"+a+"/"+b,!0,!0)},navigateToAdd:function(a){a=a?a:c.defaultTab;var b=c.rootUrl+this.options.language+"/add/"+a;this.sandbox.emit("sulu.router.navigate",b,!0,!0)},renderList:function(a){var b=this.sandbox.dom.createElement('<div id="'+c.listContainerId+'"/>');this.html(b),this.sandbox.start([{name:c.listModule,options:{el:b,language:a}}])},renderForm:function(a){this.sandbox.stop("#"+c.formContainerId);var b,d=function(a){this.sandbox.start([{name:c.formModule,options:{el:e,data:a,language:this.options.language,activeTab:this.options.content}}])}.bind(this),e=this.sandbox.dom.createElement('<div id="'+c.formContainerId+'"/>');this.html(e),b=this.getModel(this.options.id),a&&b.set({locale:a}),b.get("id")?b.fetch({data:{locale:a},success:function(a){d(a.toJSON())}.bind(this),error:function(){this.sandbox.logger.log("Error while fetching a single form")}.bind(this)}):d(b.toJSON())},languageChanged:function(a){if(this.options.language=a.id,"list"===this.options.display)this.navigateToList();else{if("form"!==this.options.display)throw"display type wrong";this.options.id?this.navigateTo(this.options.id,this.options.content):this.navigateToAdd(this.options.content)}},tabChanged:function(a){a.componentOptions.content&&(this.options.content=a.componentOptions.content)}}});